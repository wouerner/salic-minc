<?php
if (isset($this->idPreProjeto)) {
    $idPreProjeto = $this->idPreProjeto;
} elseif (isset($this->proposta->idPreProjeto)) {
    $idPreProjeto = $this->proposta->idPreProjeto;
} elseif ($this->proposta['idpreprojeto']) {
    $idPreProjeto = $this->proposta['idpreprojeto'];
}

$arrMenuProponente = array();
$arrMenuProponente['principal'] = array(
    'id' => 'informacaoinicial',
    'label' => 'Informa&ccedil;&otilde;es iniciais',
    'title' => '',
    'url' => '',
    'icon' => 'home',
    'menu' => array(),
    'grupo' => array()
);
$arrMenuProponente['principal']['menu'][] = array('label' => 'Identifica&ccedil&atilde;o da proposta', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'identificacaodaproposta', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['principal']['menu'][] = array('label' => 'Responsabilidade Social', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'responsabilidadesocial', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['principal']['menu'][] = array('label' => 'Detalhes t&eacute;cnicos', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'detalhestecnicos', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['principal']['menu'][] = array('label' => 'Outras informa&ccedil;&otilde;es', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'outrasinformacoes', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);

$arrMenuProponente['localderealizacoes'] = array(
    'id' => 'localderealizacoes',
    'label' => 'Local de realiza&ccedil;&atilde;o',
    'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'localderealizacao', 'action' => 'index', 'idPreProjeto' => $idPreProjeto)),
    'icon' => 'pin_drop',
    'menu' => array(),
    'grupo' => array()
);

$arrMenuProponente['planodedistribuicao'] = array(
    'id' => 'planodedistribuicao',
    'label' => 'Plano de distribui&ccedil;&atilde;o',
    'title' => 'Ir para plano de distribui&ccedil;&atilde;o',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'plano-distribuicao', 'action' => 'index', 'idPreProjeto' => $idPreProjeto)),
    'icon' => 'multiline_chart',
    'menu' => array(),
    'grupo' => array()
);

$arrMenuProponente['planilhaorcamentaria'] = array(
    'id' => 'planodedistribuicao',
    'label' => 'Or&ccedil;amento do projeto',
    'title' => '',
    'url' => '',
    'icon' => 'insert_chart',
    'menu' => array(),
    'grupo' => array()
);
$arrMenuProponente['planilhaorcamentaria']['menu'][] = array('label' => 'Custos Vinculados', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterorcamento', 'action' => 'custosvinculados', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['planilhaorcamentaria']['menu'][] = array('label' => 'Custos por produtos', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterorcamento', 'action' => 'produtoscadastrados', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['planilhaorcamentaria']['menu'][] = array('label' => 'Visualizar planilha', 'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterorcamento', 'action' => 'planilhaorcamentariageral', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);

$arrMenuProponente['itensorcamentario'] = array(
    'id' => 'itensorcamentario',
    'label' => 'Itens or&ccedil;ament&aacute;rios',
    'title' => '',
    'url' => '',
    'icon' => 'show_chart',
    'menu' => array(),
    'grupo' => array()
);
$arrMenuProponente['itensorcamentario']['menu'][] = array('label' => 'Solicitar inclus&atilde;o de itens', 'title' => 'Ir para Solicitar inclus&atilde;o de itens',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'mantertabelaitens', 'action' => 'index', 'idPreProjeto' => $idPreProjeto)),
    'grupo' => array()
);
$arrMenuProponente['itensorcamentario']['menu'][] = array('label' => 'Minhas solicita&ccedil;&otilde;es', 'title' => 'Ir para Minhas solicita&ccedil;&otilde;es',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'mantertabelaitens', 'action' => 'minhas-solicitacoes', 'idPreProjeto' => $idPreProjeto, 'tipoFiltro' => 'solicitado')),
    'grupo' => array(),
    'icon' => 'message'
);

$arrMenuProponente['anexardocumentos'] = array(
    'id' => 'anexardocumentos',
    'label' => 'Anexar documentos',
    'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaedital', 'action' => 'enviararquivoedital')) . '?idPreProjeto=' . $idPreProjeto,
    'icon' => 'attachment',
    'menu' => array(),
    'grupo' => array()
);

$arrMenuProponente['imprimir'] = array(
    'id' => 'imprimir',
    'label' => 'Gerar PDF',
    'title' => '',
    'url' => $this->url(array('module' => 'admissibilidade', 'controller' => 'admissibilidade', 'action' => 'imprimirpropostacultural', 'idPreProjeto' => $idPreProjeto)),
    'icon' => 'picture_as_pdf',
    'menu' => array(),
    'grupo' => array()
);

$arrMenuProponente['mensagensenviadas'] = array(
    'id' => 'mensagensenviadas',
    'label' => 'Dilig&ecirc;ncias',
    'title' => '',
    'url' => $this->url(array('module' => 'proposta', 'controller' => 'diligenciar', 'action' => 'listardiligenciaproponente', 'idPreProjeto' => $idPreProjeto)),
    'icon' => 'announcement',
    'menu' => array(),
    'grupo' => array()
);
if(count($this->recursoEnquadramentoVisaoProponente) > 0 ) {
    $arrMenuProponente['enquadramento'] = [
        'id' => 'menu_enquadramento',
        'label' => 'Enquadramento',
        'title' => 'Recurso de Enquadramento',
        'icon' => 'build',
        'menuClass' => ' light-green lighten-4',
        'url' => $this->url(
            [
                'module' => 'recurso',
                'controller' => 'recurso-proposta',
                'action' => 'visao-proponente',
                'idPreProjeto' => $idPreProjeto
            ]
        ),
        'grupo' => []
    ];
}

$arrMenuProponente['solicitacoes'] = array(
    'id' => 'minhassolicitacoes',
    'label' => 'Minhas solicita&ccedil;&otilde;es',
    'title' => '',
    'url' => $this->url(array('module' => 'solicitacao', 'controller' => 'mensagem', 'action' => 'index', 'idPreProjeto' => $idPreProjeto)),
    'menu' => array(),
    'grupo' => array()
);

if ($this->isEditavel) {

    if (!$this->isEditarProjeto) {

        $arrMenuProponente['excluirproposta'] = array(
            'id' => 'excluirproposta',
            'label' => 'Excluir proposta',
            'title' => '',
            'url' => '',
            'icon' => 'delete_forever',
            'menu' => array(),
            'grupo' => array()
        );

        $arrMenuProponente['enviarproposta'] = array(
            'id' => 'enviarproposta',
            'label' => 'Enviar proposta ao MinC',
            'title' => '',
            'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'enviar-proposta', 'idPreProjeto' => $idPreProjeto)),
            'icon' => 'send',
            'menu' => array(),
            'grupo' => array()
        );
    } else {
        $arrMenuProponente['encaminharprojetoaominc'] = array(
            'id' => 'encaminharprojetoaominc',
            'label' => 'Devolver projeto ao MinC',
            'title' => '',
            'url' => $this->url(array('module' => 'proposta', 'controller' => 'manterpropostaincentivofiscal', 'action' => 'encaminharprojetoaominc', 'idPreProjeto' => $idPreProjeto)),
            'icon' => 'send',
            'menu' => array(),
            'grupo' => array()
        );
    }

}
?>
<aside id="sidebar">
    <ul id="sidenav" class="side-nav fixed">
        <li class="sidebar-info <?php echo (!$this->isEditavel) ? 'disabled' : ''; ?>">
            <div>
                <p>
                    <i class="material-icons left tiny"><?php echo (!$this->isEditavel) ? 'lock_outline' : 'lock_open'; ?></i>
                    <b>
                        <?php echo isset($this->layout['titleShort']) ? $this->layout['titleShort'] : 'Proposta'; ?>
                        <?php echo isset($this->layout['projeto']) ? $this->layout['projeto'] : $this->proposta['idpreprojeto']; ?>
                    </b>
                </p>
                <p class="info-title">
                    <?php echo isset($this->proposta['nomeprojeto']) ? $this->proposta['nomeprojeto'] : ''; ?>
                </p>
                <?php if (isset($this->layout['prazoAlterarProjeto']) && $this->layout['prazoAlterarProjeto'] > 0) : ?>
                    <p class="">
                        <?php $n = round($this->layout['prazoAlterarProjeto']); ?>
                        <i class="material-icons left tiny">query_builder</i>
                        <span id="cronometro"></span>
                    </p>
                <?php elseif ($this->projeto): ?>
                    <p class="">
                        <i class="material-icons left tiny">query_builder</i>
                        <span id="cronometro">Prazo de altera&ccedil;&atilde;o expirado</span>
                    </p>
                <? endif; ?>
            </div>
        </li>
        <?php echo $this->partialLoop('inc/item.phtml', $arrMenuProponente); ?>
    </ul>

    <div id="trocarproponente" style="display:none">

        <form id="formtrocaproponente"
              action="<?php echo $this->url(array('module' => 'proposta', 'controller' => 'vincularresponsavel', 'action' => 'trocarproponente')); ?>"
              method="post">
            <?php
            $idVinculoProposta = "";
            if (!empty($this->dadosVinculo[0])) {
                $idVinculoProposta = $this->dadosVinculo[0]->idvinculoproposta;
            }
            ?>
            <input type="hidden" value="<?php echo $idVinculoProposta; ?>" name="idVinculoProposta"/>
            <input type="hidden" value="<?php echo $idPreProjeto; ?>" name="idPreProjeto"/>
            <input type="hidden" value="1" name="mecanismo"/>
            <table class="tabela">
                <tr>
                    <td class="titulo_tabela">Selecione um Proponente ou cadastre um novo.</td>
                </tr>
                <tr>
                    <td>
                        CPF/CNPJ Proponente:&nbsp;
                        <select name="propronente" id="propronente" class="input_simples w240">
                            <?php $idAgente = 0; ?>
                            <?php if ($this->listaProponentes): ?>
                                <?php foreach ($this->listaProponentes as $lp): $lp = array_change_key_case($lp); ?>
                                    <?php if ($lp['idagenteproponente'] != $idAgente): ?>
                                        <option
                                            value="<?php echo $lp['idvinculo']; ?>:<?php echo $lp['idagenteproponente']; ?>"><?php echo $lp['nomeproponente']; ?></option>
                                    <?php endif; ?>

                                    <?php $idAgente = $lp['idagenteproponente']; ?>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>&nbsp;<span id="msgValidaProponente"></span>&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
            </table>
        </form>
    </div>
</aside>
<script type="text/javascript">
    function layout_fluido() {
        var janela = $(window).width();

//        $("#navglobal").css("width", "100%");
//        $("#conteudo").css("width", "100%");
//        $("#titulo").css("width", "100%");
//        $("#rodapeConteudo").css("width", "100%");
//        $("#rodape").css("width", "100%");
        $("div#rodapeConteudo").attr("id", "rodapeConteudo_com_menu");
    }

    $(document).ready(function () {
        <?php if (!$this->isEditavel) : ?>
        //DESABILITA ALTERACOES NOS DADOS DO FORMULARIO (INCLUIR/ALTERAR/EXCLUIR)
        JSBloquearAlteracaoFormulario();

        $("textarea.editor").each(function () {
            $(this).editorRico({
                isDesabilitarEdicao: 1
            });
        });

        <?php endif; ?>
        $('.planilha').click(function () {
            $(this).next().toggle('fast');
        });

        $('#excluirproposta').click(function () {
            JSExcluirProposta();
        });

    });

    function JSExcluirProposta() {

        var text = 'Deseja realmente excluir sua proposta?';

        $('<div id="modalExcluirProposta"></div>').appendTo($("#sidenav")).html(text)

        $("#modalExcluirProposta").dialog("destroy");
        $("#modalExcluirProposta").dialog
        ({
            width: 450,
            height: 200,
            EscClose: false,
            modal: true
            , buttons: {
                'Cancelar': function () {
                    $(this).dialog('close');
                },
                'OK': function () {
                    window.location = "<?php echo $this->baseUrl(); ?>/proposta/manterpropostaedital/exluirproposta/?idPreProjeto=<?php echo $idPreProjeto; ?>";
                    $(this).dialog('close');
                }
            }
        });
        return false;
    }

    function trocarproponente() {

        $('<div id="trocarproponente"></div>').appendTo($("#sidenav")).html(text)

        $("#trocarproponente").dialog("destroy");
        $("#trocarproponente").dialog
        ({
            width: 600,
            height: 250,
            EscClose: false,
            modal: true,
            title: 'Trocar Proponente'
            , buttons: {
                'Cancelar': function () {
                    $(this).dialog('close'); // fecha a modal
                },
                'Novo Proponente': function () {
                    window.location = "<?php echo $this->url(array('module' => 'proposta', 'controller' => 'vincularresponsavel', 'action' => 'index')); ?>";
                },
                'Trocar Proponente': function () {
                    $("#formtrocaproponente").submit();

                }
            }
        });

        return false;
    }

    function JSPrazoDeAlterarExpirado() {
        var text = 'O prazo para alterar o projeto expirou!';

        $('<div id="modalEnviarProposta"></div>').appendTo($("#sidenav")).html(text)

        $("#modalEnviarProposta").dialog("destroy");
        $("#modalEnviarProposta").dialog
        ({
            width: 450,
            height: 200,
            position: 'center',
            EscClose: false,
            modal: true,
            buttons: {
                'OK': function () {
                    window.location = "<?php echo $this->baseUrl(); ?>/proposta/manterorcamento/produtoscadastrados/idPreProjeto/<?php echo $idPreProjeto; ?>";
                    $(this).dialog('close');
                }
            }
        });

        return false;
    }

    <?php if( isset($this->layout['prazoAlterarProjeto'])) : ?>
    var segundos = new Number();
    var segundos = <?php print $this->layout['prazoAlterarProjeto']; ?>;
    <?php endif; ?>

    function contagemregressiva() {

        if (( segundos - 1 ) >= 0) {
            segundos = segundos - 1;
            if (segundos > 86400) {
                dias = Math.round(segundos / 86400);
                cronometro.innerText = dias + ' dias para alterar';
            }
            else if (segundos > 3600) {
                horas = Math.round(segundos / 3600);
                cronometro.innerText = horas + ' horas para alterar';
            }
            else if (segundos > 60) {
                minutos = Math.round(segundos / 60);
                cronometro.innerText = minutos + ' minutos para alterar';
            }
            else if (segundos > 0) {
                cronometro.innerText = segundos + ' segundos para alterar';
            }
            else {
                JSPrazoDeAlterarExpirado();
                JSBloquearAlteracaoFormulario();
                cronometro.innerText = 'Alterar projeto encerrado';
            }
            setTimeout('contagemregressiva()', 1000);
        }
    }
    <?php if( isset($this->layout['prazoAlterarProjeto'])) : ?>
    contagemregressiva();
    <?php endif; ?>
</script>
