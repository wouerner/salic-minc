<?php $class = (empty($this->readequacao) && !$this->podeEditar) ? 'sumir' : ''; ?>

<div class="container-fluid" id="vue-container">
    <div class="row">
        <div class="page-title">
            <div class="row">
                <div class="col s12 m9 l10">
                    <h1>Readequação Plano de Distribui&ccedil;&atilde;o</h1>

                    <?php
                    gerarNovoBreadCrumb(array(
                        array('Plano de Distribui&ccedil;&atilde;o' => '')
                    ));
                    ?>
                </div>
                <div class="col s12 m3 l2 right-align">
                    <a href="javascript:voltar();" title="P&aacute;gina Anterior" title="P&aacute;gina Anterior"
                       class="btn small grey lighten-3 grey-text z-depth-0 chat-toggle"><i class="material-icons">arrow_back</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="content">
            <?php if (empty($this->readequacao)) : ?>
                <div id="mensagem" class="card">
                    <div class="card-content">
                        <p class="center-align">Aqui você pode readequar os detalhamentos do seu plano de
                            distribuição.</p>
                        <br>
                        <p class="center-align bold">
                            <a class="waves-effect waves-light btn white-text btn-incluir-novo-item"
                               id="iniciar-readequacao">
                                <i class="material-icons left">add</i>
                                <strong>Iniciar readequa&ccedil;&atilde;o</strong>
                            </a>
                        </p>
                    </div>
                </div>
            <?php endif; ?>

            <div id="cabecalho" class="card <?= $class; ?>">
                <div class="card-content">
                    <div class="row">
                        <div class="col s12">
                            <b>Pronac: </b> <?php echo $this->projeto->anoProjeto . $this->projeto->sequencial; ?>
                            <br>
                        </div>
                        <div class="col s12">
                            <b>Projeto: </b><?php echo $this->projeto->nomeProjeto; ?>
                        </div>
                    </div>
                </div>
            </div>

            <div id="readequacao" class="card <?= $class; ?>">
                <div class="card-content">
                    <input type="hidden" id="pertenceIn2017" name="pertenceIn2017" value="<?php echo $this->in2017; ?>">
                    <div id="planosDeDistribuicao">
                        <div id="dynamic-component">
                            <component
                                v-bind:is="currentComponent"
                                :id-pronac="idPronac"
                            ></component>
                        </div>
                    </div>
                </div>
            </div>

            <div id="formulario" class="card <?= $class; ?>">
                <div class="card-content">
                    <?php echo $this->partial("partials/formulario-salvar-readequacao.phtml", $this); ?>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/public/js/vue.js" type="text/javascript"></script>
<script src="/public/scripts/plugins/moment-with-locales.js"></script>
<script src="/public/scripts/plugins/numeral.min.js" type="text/javascript"></script>

<script src="/public/js/componentes/salic-table-easy.js" type="text/javascript"></script>
<script src="/public/js/componentes/salic-texto-simples.vue.js" type="text/javascript"></script>

<script src="/public/scripts/plugins/numeral.js" type="text/javascript"></script>
<script src="/public/scripts/mixins/utils.vue.js" type="text/javascript"></script>
<script src="/public/scripts/components/input-money.vue.js" type="text/javascript"></script>
<script src="/public/scripts/components/select-percent.vue.js" type="text/javascript"></script>

<script src="/public/scripts/plano-distribuicao/plano-distribuicao-listagem.vue.js" type="text/javascript"></script>

<script src="/public/scripts/readequacao/readequacao-plano-distribuicao.vue.js" type="text/javascript"></script>
<script src="/public/scripts/readequacao/readequacao-plano-distribuicao-detalhamentos.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/plano-distribuicao/plano-distribuicao-detalhamentos-formulario.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/plano-distribuicao/plano-distribuicao-detalhamentos-listagem.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/plano-distribuicao/plano-distribuicao-visualizar-produto-cabecalho.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/plano-distribuicao/plano-distribuicao-detalhamentos-consolidacao.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/plano-distribuicao/plano-distribuicao-visualizar-produto-resumido.vue.js"
        type="text/javascript"></script>
<script src="/public/scripts/proposta/visualizar/salic-proposta-detalhamento-plano-distribuicao.vue.js"
        type="text/javascript"></script>


<script>
    function carregarFormularioAntigaIN() {
        jqAjaxLinkSemLoading('<?php echo $this->Url(array('module' => 'readequacao', 'controller' => 'plano-distribuicao', 'action' => 'carregar-planos-de-distribuicao'), '', true) ?>?idPronac=<?php echo $this->idPronac; ?>', '', 'planosDeDistribuicao');
    }

    function atualizarDadosPlanosDeDistribuicao() {

        $.ajax({
            url: '<?php echo $this->url(array('module' => 'readequacao', 'controller' => 'readequacoes', 'action' => 'consultar-readequacao'), '', true); ?>',
            type: "POST",
            data: {
                idPronac: <?php echo $this->idPronac; ?>,
                idTipoReadequacao: 11,
                idReadequacao: $("#idReadequacao").val()
            },
            success: function (data) {
                var readequacoes = data.readequacoes;

                // @todo remove
                var readequacao = (typeof readequacoes.length != 'undefined') ? readequacoes[0] : readequacoes;

                if (typeof readequacao !== 'undefined') {
                    $('#idReadequacao').val(readequacao.idReadequacao);
                    tinyMCE.get('descJustificativa').setContent(readequacao.dsJustificativa);
                }
            }
        });
    }

    new Vue({
        el: '#dynamic-component',
        data: {
            currentComponent: '',
            active: false,
            idPronac: <?= $this->projeto->IdPRONAC;?>
        },
        mounted: function () {
            this.iniciarReadequacao();
        },
        methods: {
            iniciarReadequacao: function () {
                let self = this;
                $("#iniciar-readequacao").on("click", function () {
                    $("#mensagem").fadeOut('fast');
                    $(".card.sumir").fadeIn().removeClass('sumir');

                    self.carregarComponenteSelecionado();
                });

                if($("#idReadequacao").val() != "") {
                    self.carregarComponenteSelecionado();
                }
            },
            carregarComponenteSelecionado: function () {
                let self = this;

                let componente = '';
                if (self.projetoPertenceIN2017() == 1) {
                    componente = "readequacao-plano-distribuicao";
                } else {
                    self.carregarPlanoDistribuicaoAntigaIN();
                }
                self.currentComponent = componente;
            },
            projetoPertenceIN2017: function () {
                return $("#pertenceIn2017").val();
            },
            carregarPlanoDistribuicaoAntigaIN: function () {
                carregarFormularioAntigaIN();
//                atualizarDadosPlanosDeDistribuicao();
            }
        }
    })
</script>

<style>
    table tr.linha-excluida {
        text-decoration: line-through;
    }

    table tr.linha-excluida td {
        background-color: #dcdcdc;
        color: #777
    }

    table tr.linha-atualizada td,
    table tr.linha-incluida td {
        background-color: #d0e8d6
    }

</style>