<script src="/public/js/vue.js" type="text/javascript"></script>
<script type="text/javascript" src="/public/js/componentes/sl-btn-visualizar.js" ></script>
<script type="text/javascript" src="/public/js/componentes/sl-collapse-visualizar.js" ></script>
<script type="text/javascript" src="/public/js/componentes/salic-table-easy.js" ></script>
<script src="/public/scripts/prestacao-contas/components/button-scroll-top.vue.js"></script>
<script src="/public/scripts/diligencia/diligencia/cadastrar.vue.js"></script>
<div class="container-fluid" id="vue-container">
    <div class="page-title">
        <div class="row">
            <div class="col s12 m9 l10">
                <h1>Presta&ccedil;&atilde;o de Contas: Planilha or&ccedil;ament&aacute;ria comprovada</h1>
            </div>
            <div class="col s12 m3 l2 right-align">
                <a href="javascript:voltar();" title="Página Anterior"title="Página Anterior" class="btn small grey lighten-3 grey-text z-depth-0 chat-toggle"><i class="material-icons">keyboard_return</i>
                </a>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- div class="col s2">
            <?php
                $tpAgente = filter_input(INPUT_GET, 'tpAgente');
                if (empty($tpAgente)) {
                    //echo $this->partial("realizarprestacaodecontas/inc/menu.inc.php", $this);
                }
            ?>

            <script language="javascript">
                function AnalisarProjeto() {
                    $("#analisar").dialog("destroy");
                    $('html').css('overflow', 'hidden');
                    $("#analisar-confirm").dialog
                    ({
                        width:650,
                        height:430,
                        modal: true,
                        draggable: true,
                        resizable: true,
                        closeOnEscape: false,
                        buttons: {
                            'Salvar': function(){
                                redirecionar('<?php echo $this->url(array('controller' => 'analisaritem', 'action' => 'tecnicoprestacaocontas'), '', true); ?>');
                            },
                            'Cancelar': function(){
                                $(this).dialog('close');
                            }
                        }
                    });
                    $('.ui-dialog-titlebar-close').open();
                } // fecha função logout()
            </script>
            <style>
                .editarIco {
                    display: block;
                    width: 15px;
                    text-indent: -99999px;
                    overflow: hidden;
                    background-image: url('<?php echo $this->baseUrl(); ?>/public/img/edit_ico.gif');
                    background-repeat: no-repeat;
                }
            </style>
            <div id="enviar-confirm" class="sumir" title="Finalizar Análise"><p aling="Center">Deseja realmente finalizar a análise?</p></div>
            <script language="javascript">
                function EnviarChefeDivisao() {
                    $("#enviar").dialog("destroy");
                    $("#enviar-confirm").html("");
                    $('html').css('overflow', 'hidden');
                    $("#enviar-confirm").dialog
                    ({
                        height: 200,
                        modal: true,
                        draggable: false,
                        resizable: false,
                        closeOnEscape: false,
                        title: "Envio de Projeto",
                        buttons: {
                            'Não': function(){
                                $(this).dialog('close');
                            },
                            'Sim': function(){
                                redirecionar("<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'enviarchefedivisao')) .'?idPronac=' . $IdPronac; ?>");
                            }
                        }
                    });
                    $('.ui-dialog-titlebar-close').remove();
                } // fecha função logout()
            </script>

            <div id="enviar-confirm" class="sumir" title="Finalizar Análise"><p>Deseja realmente finalizar a análise?</p></div>

            <!-- MODAL DA CHEFE DE DIVISÃO  -->
            <script language="javascript">
                function chefedivisao() {
                    $("#analisar").dialog("destroy");
                    $("#analisar-confirm").html("");
                    $('html').css('overflow', 'hidden');
                    $("#analisar-confirm").dialog
                    ({
                        width:800,
                        height:430,
                        modal: true,
                        draggable: true,
                        resizable: false,
                        closeOnEscape: false,
                        title: "Enviar Chefe de Divisão",
                        buttons: {
                            'Não': function(){
                                $(this).dialog('close');
                            },
                            'Sim': function(){
                                redirecionar("<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'enviarchefedivisao')) .'?idPronac=' . $IdPronac; ?>");
                            }
                        }
                    });
                    $('.ui-dialog-titlebar-close').open();
                } // fecha função logout()
            </script>

            <div id="analisar-confirm" style="width:220px" class="sumir" title="Enviar Chefe de Divisão"></div>
            <!-- FIM DA MODAL DO CHEFE DE DIVISÃO -->

            <?php
                $comprovacaoPagamentoHref   =   $this->url(array('controller' => 'comprovarexecucaofinanceira', 'action' => 'comprovacaopagamento'));
                $descreverItemHref          =   $this->url(array('controller' => 'comprovarexecucaofinanceira', 'action' => 'descreveritem'));
                $voltarHref                 =   $this->url(array('controller' => 'comprovarexecucaofinanceira', 'action' => ''));
                $finalizarHref              =   $this->url(array('controller' => 'comprovarexecucaofinanceira', 'action' => 'finalizar'));
                $finalizadoHref             =   $this->url(array('controller' => 'comprovarexecucaofinanceira', 'action' => 'finalizado')).'?cadastro=1&idpronac='.$this->idpronac;
            ?>
        </div -->

    <?php echo $this->partial('partials/card-projeto.phtml', 'prestacao-contas', $this); ?>
   <div class="card">
    <div class="card-content">
            <?php
                $validaA = true;
                $validab = true;
                foreach($this->incFiscaisA as $titulo => $item) {
                    if(!(is_array($item) and count($item)>0)){
                        $validaA = false;
                    }
                }
                foreach($this->incFiscaisP as $titulo => $item) {
                    if(!(is_array($item) and count($item)>0)){
                        $validab = false;
                    }
                } ?>
                <?php if($validaA || $validab): ?>
                    <div id="pagamentoAjax">
                        <fieldset>
                            <legend>Comprova&ccedil;&atilde;o de Execu&ccedil;&atilde;o Financeira</legend>
                            <form name="frPagamento" id="frPagamento" >
                                <input type="hidden" name="idPronac" value="<?php echo $this->idPronac;?>" />
                                    <table id="planilhaItem" class="tabela bordered">
                                        <tr>
                                            <td>
                                                <?php if($this->incFiscaisA): ?>
                                                    <?php foreach($this->incFiscaisA as $titulo => $item): ?>
                                                        <div>
                                                        <span class='green-text'><?php echo $titulo ?></span>
                                                        <?php if(!empty($item)): ?>
                                                            <?php foreach($item as $titulo => $subItem) :?>
                                                                <div style="padding-left: 15px;">
                                                                    <span class='orange-text'><?php echo $titulo ?></span>
                                                                    <?php if(!empty($subItem)): ?>
                                                                        <?php foreach($subItem as $titulo => $tabelaItem): ?>
                                                                            <div style="padding:3px; margin-left: 15px;">
                                                                                <?php $id =  rand(); ?>
                                                                                <button class="waves-effect waves-light btn btn-flat btnToggleCustos"
                                                                                    uf="<?php echo $tabelaItem['uf']; unset($tabelaItem['uf']) ?>"
                                                                                    idmunicipio="<?php echo $tabelaItem['idMunicipio']; ?>"
                                                                                    produto="<?php echo $tabelaItem['cdProduto']; ?>"
                                                                                    id="<?php echo $id; ?>"
                                                                                >
                                                                                    <i class="material-icons left">chevron_right</i><?php echo $titulo ?>
                                                                                </button>
                                                                                <div id="div<?php echo $id; ?>"></div>
                                                                            </div>
                                                                        <?php endforeach ?>
                                                                    <?php endif?>
                                                                </div>
                                                            <?php endforeach ?>
                                                        <?php endif ?>
                                                        </div>
                                                    <?php endforeach ?>
                                                <?php endif ?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <?php if(!empty($this->incFiscaisP)): ?>
                                                    <?php foreach($this->incFiscaisP as $titulo => $item) : ?>
                                                        <div style="padding:3px; margin-left: 15px;" >
                                                            <span class='green-text'><?php echo $titulo ?></span>
                                                            <?php if(!empty($item)): ?>
                                                                <?php foreach($item as $titulo => $tabelaItem): ?>
                                                                    <div style="padding:3px; margin-left: 15px;">
                                                                        <span class='orange-text'><?php echo $titulo ?></span>
                                                                        <?php if(!empty($subItem)): ?>
                                                                            <?php $id =  rand(); ?>
                                                                            <div style="padding:3px; margin-left: 15px;">
                                                                                <button class="waves-effect waves-light btn-flat btn btnToggle"
                                                                                        id="<?php echo $id; ?>"
                                                                                        uf="<?php echo $tabelaItem['uf']; ?>"
                                                                                        idmunicipio="<?php echo $tabelaItem['idMunicipio']; ?>"
                                                                                        produto="<?php echo $tabelaItem['cdProduto']; ?>"
                                                                                        idPlanilhaEtapa="<?php echo $tabelaItem['cdEtapa']; ?>">
                                                                                    <i class="material-icons left">chevron_right</i><?php echo $titulo ?>
                                                                                </button>
                                                                                <div id="div<?php echo $id; ?>"></div>
                                                                            </div>
                                                                        <?php endif;  ?>
                                                                    </div>
                                                                <?php endforeach;  ?>
                                                            <?php endif;  ?>
                                                        </div>
                                                    <?php endforeach; ?>
                                                <?php endif; ?>
                                            </td>
                                        </tr>
                                </table>
                            </form>
                        </fieldset>
                <?php else: ?>
                    <fieldset>
                        <legend>Comprova&ccedil;&atilde;o de Execu&ccedil;&atilde;o Financeira</legend>
                        <form name="frPagamento" id="frPagamento" >
                            <input type="hidden" name="idPronac" value="<?php echo $this->idPronac;?>" />
                            <table class="tabela">
                                <tr><th colspan="3">Filtro de Pesquisa</th></tr>
                                <tr class="divFiltroPesquisa">
                                    <td class="destacar bold">Situa&ccedil;&atilde;o</td>
                                    <td>
                                    </td>
                                    <td colspan="6" align="center">
                                        <button type="submit" id="btn_pesquisar" class="btn" value="">Pesquisar</button>
                                        <?php if($this->coordenador){ ?>
                                            <input type="button" name="redistribuir" id="redistribuir" class="btn_devolver_tecnico" value="">
                                        <?php } ?>
                                    </td>
                                </tr>
                            </table>
                         </form>
                         <table class="tabela">
                             <tr>
                                 <td align="center">Nenhum registro encontrado.</td>
                             </tr>
                         </table>
                    </fieldset>
                <?php endif ?>
        </div>
    </div>
    </div>
    <?php echo $this->partial('partials/menu-fixo.phtml', 'prestacao-contas', $this); ?>
    </div>


    <?php $analisarItemHref   =   $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'analisaritem'));?>
    <script type="text/javascript">
        var bus = new Vue({});
        var app = new Vue({
            el: '#vue-container'
        });
    </script>
    <script type="text/javascript">
        <?php if(isset($_GET['tipoMsg'])):?>
            $("#novas_mensagens", document).append("<div class='msg<?php echo $_GET['tipoMsg']; ?>'><div class='float_right'><input type='button' class='btn_close' title='Fechar mensagem' id='msg<?php echo $_GET['tipoMsg']; ?>' onclick='$(\".msg<?php echo $_GET['tipoMsg']; ?>\").hide();' onkeypress='$(\".msg<?php echo $_GET['tipoMsg']; ?>\").hide();'/></div><div><?php echo $_GET['msg'] ?></div></div>");
        <?php endif;?>

        function analisarItem(idPlanilhaAprovacao, idPronac, idPlanilhaItem){
            window.location='<?php echo $analisarItemHref; ?>?idPronac=' + idPronac + '&idPlanilhaAprovacao=' + idPlanilhaAprovacao+ '&idPlanilhaItem=' + idPlanilhaItem;
            return false;
        }

        regra = new Object();
        regra = /(icn_mais.gif)/i;
        $(function(){
            $('.divPai').click(function(){
                $('.'+$(this).attr('divFilho')).toggle();
                if(regra.exec($('img', $(this)).attr('src'))) {
                    $(this).find('img').attr('src','<?php echo $this->baseUrl();?>/public/img/icn_menos.gif');
                }
                else{
                    $(this).find('img').attr('src','<?php echo $this->baseUrl();?>/public/img/icn_mais.gif');
                }
            });
        });

        $('#pagamentoAjaxBt a').click(function(){
            var este = this;
            var dados = $('#frPagamento').serializeArray();
            if($(este).attr('retorna')==undefined){
                var info = {
                    este        :   este,
                    corpo       :   'pagamentoAjaxBt',
                    parametros  :   dados,
                    formularioModal     :   'frComprovarPagamento',
                    naoFechar           :   true
                };
                acoesLink(info);
                return false;
            }
        });
        $('#frPagamento').find('input').click(function(){
            var este = this;
            if($(este).attr('type') == 'checkbox'){
                var verifica = false;
                $('#frPagamento').find('.ckItens').each(function(){
                    if($(este).attr('id') == $(this).attr('id')){
                        if($(this).attr('checked'))
                            verifica = true;
                    }
                });
                $('#frPagamento').find('.ckItens').each(function(){
                    if($(este).attr('id') != $(this).attr('id')){
                        if($(este).attr('checked') || verifica)
                            $(this).attr('disabled',true);
                        else
                            $(this).attr('disabled',false);
                    }
                });
            }
        });

        $('#btComprovar').click(function(){
            var dados = $('#frPagamento').serializeArray();
            var verifica = false;
            $('#frPagamento').find('.ckItens').each(function(){
                if($(this).attr('checked'))
                    verifica = true;
            });
            if(verifica){
                var pagina = requisicaoAjaxObj();
                pagina.executar({
                    pagina: $(this).attr('href'),
                    parametros:dados
                });
            }
            else{
                janelaAlerta('Selecione um ou mais itens!');
            }
            return false;
        });

        $('.dadosDoc').click(function(){
            var nomeJanelalicitacaoanterior      =   janelaObj({
                parametros : {
                    width:800,
                    autoOpen: false,
                    modal:true,
                    resizable: false
                },
                title : 'Nome do Item de Custo'
            });
            var carregarCont    =   requisicaoAjaxObj();
            carregarCont.executar({
                pagina      :   $(this).attr('href'),
                parametros:{id:$(this).attr('id')},
                resposta    :   nomeJanelalicitacaoanterior.divConteudo
            });
            nomeJanelalicitacaoanterior.abrirJanela();

            return false;
        });
        $('#finalizar').click(function(){
            var este = this;
            var nomeJanelaAlerta =   janelaObj({
                parametros : {
                    width:      400,
                    autoOpen:   false,
                    resizable:  false,
                    modal:      true,
                    buttons: {
                        'Nao': function() {
                            $(this).dialog('close');
                        },
                        'Sim': function() {

                            var resposta = buscarJson($(este).attr('href'),{idPronac:'<?php echo $this->idpronac;?>'});
                            if(resposta.resultado){
                                janelaAlerta(resposta.mensagem,function(){
                                    window.location = '<?php echo $finalizadoHref;?>';
                                });
                            }
                            else{
                                janelaAlerta(resposta.mensagem);
                            }

                            $(this).dialog('close');
                        }
                    }
                },
                removerBtFechar:true,
                title : 'Alerta'
            });
            nomeJanelaAlerta.divConteudo.html('Deseja finalizar a Comprova&ccedil;&atilde;o?');
            nomeJanelaAlerta.abrirJanela();
        });

        $('.btnToggleCustos').click(function(event) {
            event.preventDefault()
            btn = jQuery(this);
            btnId = btn.attr('id');
            table = jQuery('table.' + btnId);

            idPronac = jQuery('input[name=idPronac]').val();

            url = '/realizarprestacaodecontas/planilha-orcamentaria-custos/idPronac/'+ idPronac
                +'/uf/' + btn.attr('uf')
                +'/produto/' + btn.attr('produto')
                + '/idmunicipio/' + btn.attr('idmunicipio');

            btnAjax(url, this);
        });

        $('.btnToggle').click(function(event) {
            event.preventDefault()

            btn = jQuery(this);
            btnId = btn.attr('id');
            idPronac = jQuery('input[name=idPronac]').val();
            produto = btn.attr('produto');
            i = btn.find('i');

            if ( "" == btn.attr('produto')){
                produto = 0;
            }

            url = '/realizarprestacaodecontas/planilha-orcamentaria-custos-produto'
                +'/idPronac/' + idPronac
                + '/uf/' + btn.attr('uf')
                + '/idplanilhaetapa/' + btn.attr('idplanilhaetapa')
                + '/idmunicipio/' + btn.attr('idmunicipio')
                + '/produto/' + produto;
            console.log(url);

            btnAjax(url, this);
        });

        function btnAjax(url, btn)
        {
            btn = jQuery(btn);
            btnId = btn.attr('id');
            i = btn.find('i');

            if (jQuery('#div'+ btnId).is(':empty')) {

                $.get(url, function(data){
                    jQuery('#div'+ btnId).html(data);
                    i.text('expand_more')
                    //
                    $( "ul.tabs" ).unbind();
                    $3('ul.tabs').tabs();
                });

            } else {

                div = jQuery('#div'+ btnId);
                div.toggleClass('hide');
                if (i.text() == 'chevron_right'){
                    i.text('expand_more')
                } else {
                    i.text('chevron_right')
                }
            }
        }

        $3(document).ready(function () {

            $3("#visualizar-form").on('click', function () {
                tinymce.remove();
            });

            if ($3('#ir-para-o-topo').length) {
                var scrollTrigger = 100, // px
                    backToTop = function () {
                        var scrollTop = $3(window).scrollTop();
                        if (scrollTop > scrollTrigger) {
                            $3('#ir-para-o-topo').parent().show();
                        } else {
                            $3('#ir-para-o-topo').parent().hide();
                        }
                    };
                backToTop();

                $3(window).on('scroll', function () {
                    backToTop();
                });

                $3('#ir-para-o-topo').on('click', function (e) {
                    e.preventDefault();
                    $3('html,body').animate({
                        scrollTop: 0
                    }, 700);
                });
            }
        });
    </script>
</div>

