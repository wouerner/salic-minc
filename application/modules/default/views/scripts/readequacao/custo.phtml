<?php
/**
 * PLANILHA DE CUSTOS: Itens da planilha de custo do projeto
 * @author emanuel.sampaio <emanuelonline@gmail.com>
 * @since 30/03/2012
 * @version 1.0
 * @package application
 * @subpackage application.views.scripts.readequacao
 * @copyright © 2012 - Ministério da Cultura - Todos os direitos reservados.
 * @link http://salic.cultura.gov.br
 */

require_once "inc/menu.inc.php"; // menu
// define o tipo de custo
$tpCusto = empty($this->idProduto) ? 'Custo administrativo' : 'Custo por produtos';
$dsCusto = empty($this->idProduto) ? 'Custo administrativo' : 'Nome do produto: ' . $this->Produto;

$urlPronac = null;
$urlPronac = (isset($this->idPronac)) ? "?idPronac=".Seguranca::encrypt($this->idPronac) : "";
$idPronacCrip = Seguranca::encrypt($this->idPronac);
?>

<script type="text/javascript">
/**
 * Ações que serão executadas após o carregamento da página
 */
    $(document).ready(function() {
        // máscaras dos campos
        $('#qtd, #ocorrencia').keyup(function() {
            mascara(this, format_num); // somente números
        });
	$('#vlUnitario').keyup(function() {
            mascara(this, format_moeda); // moeda
	});
	// carrega as combos
	$('#etapa').change(function(){ // ETAPA
            carregar_combo(this.value, 'item', '<?php echo $this->url(array('controller' => 'planilhaitens', 'action' => 'combo-com-id-produto')); ?>', ' - Selecione uma Etapa - ');
	});
	$('#uf').change(function(){ // UF
            carregar_combo(this.value, 'cidade', '<?php echo $this->url(array('controller' => 'municipios', 'action' => 'combo')); ?>', ' - Selecione uma UF - ');
	});

	// campos desabilitados
	document.getElementById('total').disabled = true;

	// cálculo do total (quantidade * ocorrencia * valor unitário)
	$('#qtd, #ocorrencia, #vlUnitario').blur(function(){
            qtd = document.getElementById('qtd').value;
            qtd = qtd.replace(/\D/g, ""); // retira os pontos e as vírgulas, deixando somente números
            qtd = qtd.replace(/(\d{0})(\d)/, "$1$2");
            qtd = parseInt(qtd); // converte para int

            ocorrencia = document.getElementById('ocorrencia').value;
            ocorrencia = ocorrencia.replace(/\D/g, ""); // retira os pontos e as vírgulas, deixando somente números
            ocorrencia = ocorrencia.replace(/(\d{0})(\d)/, "$1$2");
            ocorrencia = parseInt(ocorrencia); // converte para int

            vlUnitario = document.getElementById('vlUnitario').value;
            vlUnitario = vlUnitario.replace(/\D/g, ""); // retira os pontos e as vírgulas, deixando somente números
            vlUnitario = vlUnitario.replace(/(\d{0})(\d)/, "$1$2");
            vlUnitario = vlUnitario.replace(/(\d)(\d{2})$/, "$1.$2"); // adiciona o ponto na casa decimal
            vlUnitario = parseFloat(vlUnitario).toFixed(2); // converte para float e adiciona precisão decimal

            total = parseFloat(qtd * ocorrencia * vlUnitario).toFixed(2); // armazena o resultado

            // formata a saída do total
            if (isNaN(total)){ // se não for número
                total = '';
            } else {
                // formata para real
                total = total.replace(/\D/g, "");
                total = total.replace(/(\d)(\d{2})$/, "$1,$2");
                total = total.replace(/(\d+)(\d{3},\d{2})$/g, "$1.$2");

                var q = (total.length - 3) / 3; // quantidade caracteres
                var c = 0; // contador
                while (q > c)
                {
                        c++;
                        total = total.replace(/(\d+)(\d{3}.*)/, "$1.$2");
                }
                total = total.replace(/^(0+)(\d)/g, "$2");
                total = 'R$ ' + total;
            }
            document.getElementById('total').value = total;
	});

	// controle de exibição da planilha aprovada
	$(".icn_menos_AP").click(function(){
            abrir_planilha(this, '');
	});
	$(".icn_menos_AP").click();

	// controle de exibição da planilha solicitada
	$(".icn_menos_SR").click(function(){
            abrir_planilha(this, 'SR');
	});
	$(".icn_menos_SR").click();

	// efeitos ao passar o mouse sobre o item
	$(".item").mouseover(function(){
            $(this).addClass('fundo_linha3');
	});
	$(".item").mouseout(function(){
            $(this).removeClass('fundo_linha3');
	});

	$(".item").click(function(){
            if ($(this).hasClass('fundo_linha4')) {
                $(this).removeClass('fundo_linha4');
            } else {
                $(this).addClass('fundo_linha4');
            }
	});

	// exclusão do produto
	$('.btn_exclusao').click(function() {
            $('#tpAcao').attr('value', 'E');
            $('#btn_salvar').click();
	});
    });

    /**
     * Função para expandir/recolher a planilha
     */
    function abrir_planilha(item, planilha) {
	var tipo    = $(item).attr('tipo' + planilha);
	var aberto  = $(item).attr('aberto' + planilha);
	var fonte   = 'fonte' + planilha;
	var produto = 'produto' + planilha;
	var etapa   = 'etapa' + planilha;
	var cidade  = 'cidade' + planilha;

	if (aberto == 'true') {
            adisplay = 'none';
            $(item).attr('aberto' + planilha, 'false');
            $(item).removeClass('icn_menos').addClass('icn_mais');
	} else {
            adisplay = '';
            $(item).attr('aberto' + planilha, 'true');
            $(item).removeClass('icn_mais').addClass('icn_menos');
	}

	if (tipo == fonte) {
            fonte = $(item).attr('fonte' + planilha);
            $(".master" + planilha + "[fonte" + planilha + "='" + fonte + "']").css('display', adisplay);
            $(".clickproduto" + planilha + ", .clicketapa" + planilha + ", .clickcidade" + planilha).removeClass('icn_mais').addClass('icn_menos');
	}
	if (tipo == produto) {
            fonte   = $(item).attr('fonte' + planilha);
            produto = $(item).attr('produto' + planilha);
            $(".produto" + planilha + "[produto" + planilha + "='" + produto + "'][fonte" + planilha + "='" + fonte + "']").css('display', adisplay);
            $(".clicketapa" + planilha + ", .clickcidade" + planilha).removeClass('icn_mais').addClass('icn_menos');
	}
	if (tipo == etapa) {
            fonte   = $(item).attr('fonte' + planilha);
            produto = $(item).attr('produto' + planilha);
            etapa   = $(item).attr('etapa' + planilha);
            $(".etapa" + planilha + "[produto" + planilha + "='" + produto + "'][etapa" + planilha + "='" + etapa + "'][fonte" + planilha + "='" + fonte + "']").css('display', adisplay);
            $(".clickcidade" + planilha).removeClass('icn_mais').addClass('icn_menos');
	}
	if (tipo == cidade) {
            fonte   = $(item).attr('fonte' + planilha);
            produto = $(item).attr('produto' + planilha);
            etapa   = $(item).attr('etapa' + planilha);
            cidade  = $(item).attr('cidade' + planilha);
            $(".cidade" + planilha + "[produto" + planilha + "='" + produto + "'][etapa" + planilha + "='" + etapa + "'][cidade" + planilha + "='" + cidade + "'][fonte" + planilha + "='" + fonte + "']").css('display', adisplay);
	}
    } // fecha função abrir_planilha()

    /**
     * Função para solicitar alteração do item
     */
    function alterar_item(idPlanilhaAprovacao) {
	carregandoModal();
	$.ajax({
            type: 'POST',
            url: '<?php echo $this->url(array('controller' => 'readequacao', 'action' => 'pop-form-custo')); ?>',
            data: {
                idPlanilhaAprovacao: idPlanilhaAprovacao,
                popularForm: 'S'
            },
            success: function(data) {
                // limpa/reseta os campos
                $("#etapa").val();
                $("#unidade").val();
                $("#qtd").val();
                $("#ocorrencia").val();
                $("#vlUnitario").val();
                $("#total").val();
                $("#dias").val();
                $("#fonte").val();
                $("#uf").val();
                $("#justificativa").val();
                $("#idPlanilhaAprovacao").val();
                $("#stPedidoAlteracao").val('T');
                $("#siVerificacao").val('0');
                $("#tpAlteracaoProjeto").val('10');
                $("#tpAcao").val('A');

                // popula o formulário
                $.ajax({
                    type: 'POST',
                    url: '<?php echo $this->url(array('controller' => 'readequacao', 'action' => 'pop-itens-custo')); ?>',
                    data: {
                        idEtapa: data.idEtapa,
                        popularEtapas: 'S'
                    },
                    success: function(dados) {
            		if (!dados.error) {
                            $('#item').find('option').remove();
                            $('#item').append('<option value=""> - Selecione - </option>');
                            for (i in dados) {
                                if(i != 'error') {
                                    if (data.idPlanilhaItem == dados[i].id) {
                                        $('#item').append('<option value="' + dados[i].id + '" selected="selected">' + dados[i].descricao + '</option>');
                                    } else {
                                        $('#item').append('<option value="' + dados[i].id + '">' + dados[i].descricao + '</option>');
                                    }
                                }
                            }
            		} else {
                            $('#item').find('option').remove();
                            $('#item').append('<option value=""> - Selecione - </option>');
            		}
                    }
                    ,dataType: 'json'
                });
                $("#tpPlanilhaEnviada").val(data.tpPlanilha);
                $("#etapa").val(data.idEtapaEProduto);
                $("#unidade").val(data.idUnidade);
                $("#qtd").val(parseInt(data.qtItem));
                $("#ocorrencia").val(parseInt(data.nrOcorrencia));
                $("#vlUnitario").val(parseFloat(data.vlUnitario).toFixed(2).replace('.', ','));
                $("#vlUnitario").keyup();
                $("#vlUnitario").blur();
                $("#dias").val(data.qtDias);
                $("#fonte").val(data.nrFonteRecurso);
                $("#uf").val(data.idUF);
                $("#justificativa").val(data.dsJustificativa);
                $("#idPlanilhaAprovacao").val(data.idPlanilhaAprovacao);
                fecharModal('carregandoModalAjax');
                $('html, body').animate({scrollTop: $("#ancora").offset().top}, 2000);
                carregar_combo(data.idUF, 'cidade', '<?php echo $this->url(array('controller' => 'municipios', 'action' => 'combo')); ?>', ' - Selecione - ', data.idMunicipio);

//                $("#etapa").attr('disabled','disabled');
//                $("#item").attr('disabled','disabled');
            }
            ,dataType: 'json'
	});

	$('#btn_exclusao').show(); // exibe o botão de exclusão
    } // fecha função alterar_item()
</script>
<div id="msgAlerta" class="sumir"></div>

<!-- ========== INÍCIO BREADCRUMB (LINKS TOPO) ========== -->
<div id="breadcrumb">
    <ul>
        <li class="first"><a href="<?php echo $this->url(array('controller' => 'principalproponente', 'action' => ''), null, true); ?>" title="Ir para p&aacute;gina inicial" onclick="carregandoModal();">In&iacute;cio</a></li>
        <li class="second"><a href="<?php echo $this->url(array('controller' => 'consultardadosprojeto', 'action' => ''), null, true); ?><?php echo $urlPronac; ?>" title="Ir para In&iacute;cio" onclick="carregandoModal();">Consultar dados do Projeto</a></li>
        <li>Readequa&ccedil;&atilde;o de projeto</li>
        <li class="last"><?php echo $tpCusto; ?></li>
    </ul>
</div>
<!-- ========== FIM BREADCRUMB (LINKS TOPO) ========== -->

<!-- ========== INÍCIO TÍTULO ========== -->
<div id="titulo">
    <div>Readequa&ccedil;&atilde;o de custo - <?php echo $tpCusto ?> <span class="voltar"><a href="javascript:voltar();" title="Ir para p&aacute;gina anterior">Voltar</a></span></div>
</div>
<!-- ========== FIM TÍTULO ========== -->

<!-- ========== INÍCIO CONTEÚDO ========== -->
<div id="conteudo">
    <!-- ========== INÍCIO TOPO PROJETO ========== -->
    <?php require_once "inc/topo.inc.php"; ?>
    <!-- ========== FIM TOPO PROJETO ========== -->

    <!-- ========== INÍCIO PLANILHA APROVADA ========== -->
        <table class="tabela">
            <tr>
                <th>Planilha Aprovada</th>
            </tr>

		<?php if (count($this->planAP) <= 0) : ?>
		<tr>
                    <td align="center">N&atilde;o existe(m) item(ns) aprovado(s) para esse produto.</td>
		</tr>
		<?php endif; ?>

		<?php
		$nrFonte = 0;
		$item    = 1;
		foreach ($this->planAP as $fonte => $planilha) : //ForeachFonteIncentivo
		?>
			<tr>
                            <td>
                                <div tipo="fonte" fonte="<?php echo $nrFonte; ?>" aberto="true" class="icn_menos icn_menos_AP" style="width:90%"><span class="red" style="font-size: 20pt; font-weight: 800;"><?php echo $fonte; ?></span></div>
                            </td>
			</tr>
			<?php
			$nrProduto    = 0;
			$totalProduto = 0;
			if (is_array($this->planAP[$fonte]))
				foreach ($this->planAP[$fonte] as $produto => $planilha) : //ForeachProduto
			?>
				<tr class="master" fonte="<?php echo $nrFonte; ?>">
                                    <td class="master">
                                        <div tipo="produto" aberto="true" fonte="<?php echo $nrFonte; ?>" produto="<?php echo $nrProduto; ?>" class="icn_menos icn_menos_AP clickproduto" style="width:98%; margin-left:2%;"><span class="green" style="font-size: 16pt; font-weight: 800;"><?php echo $produto; ?></span></div>
                                    </td>
				</tr>
				<?php
				$nrEtapa = 0;
				if (is_array($this->planAP[$fonte][$produto]))
					foreach ($this->planAP[$fonte][$produto] as $etapa => $planilha) : //ForeachEtapa
						$totalEtapa = 0;
				?>
					<tr class="master produto" produto="<?php echo $nrProduto; ?>" fonte="<?php echo $nrFonte;?>">
                                            <td>
                                                <div>
                                                    <div tipo="etapa" fonte="<?php echo $nrFonte; ?>" produto="<?php echo $nrProduto; ?>" etapa="<?php echo $nrEtapa; ?>" aberto="true" class="icn_menos icn_menos_AP clicketapa" style="width:80%; margin-left:4%; "><span class="orange" style="font-size: 14pt; font-weight: 800;"><?php echo $etapa; ?></span></div>
                                                </div>
                                            </td>
					</tr>
					<?php
					$nrCidade = 0;
						if (is_array($this->planAP[$fonte][$produto][$etapa]))
							foreach ($this->planAP[$fonte][$produto][$etapa] as $cidade => $planilha) : //ForeachCidade
					?>
						<tr class="master produto etapa" produto="<?php echo $nrProduto; ?>" etapa="<?php echo $nrEtapa; ?>" fonte="<?php echo $nrFonte; ?>">
                                                    <td>
                                                        <div tipo="cidade" fonte="<?php echo $nrFonte; ?>" produto="<?php echo $nrProduto; ?>" etapa="<?php echo $nrEtapa; ?>" cidade="<?php echo $nrCidade; ?>" aberto="true" class="icn_menos icn_menos_AP clickcidade" style="width:94%; margin-left:6%;"><span class="black" style="font-size: 12pt; font-weight: 800;"><?php echo $cidade; ?></span></div>
                                                    </td>
						</tr>
						<tr class="master produto etapa cidade" produto="<?php echo $nrProduto; ?>" etapa="<?php echo $nrEtapa; ?>" cidade="<?php echo $nrCidade; ?>"  fonte="<?php echo $nrFonte; ?>">
                                                    <td>
                                                        <table class="tabela">
                                                            <tr class="master produto etapa cidade" produto="<?php echo $nrProduto; ?>" etapa="<?php echo $nrEtapa; ?>" cidade="<?php echo $nrCidade; ?>" fonte="<?php echo $nrFonte;?>">
                                                                <th>Item</th>
                                                                <th>Unidade</th>
                                                                <th>Quant.</th>
                                                                <th>Ocorr.</th>
                                                                <th>Vl. Unit&aacute;rio</th>
                                                                <th>Total</th>
                                                                <th>Qtd. Dias</th>
                                                                <th>Justificativa</th>
                                                            </tr>
                                                            <?php
                                                            $totalUF = 0;
                                                            if (is_array($this->planAP[$fonte][$produto][$etapa][$cidade]))
                                                                    foreach ($this->planAP[$fonte][$produto][$etapa][$cidade] as $planilha) : //ForeachItem
                                                                            $totalUF += $planilha['vlTotal'];
                                                            ?>
                                                                    <tr class="item">
                                                                            <td><a href="javascript:alterar_item('<?php echo $planilha['idPlanilhaAprovacao']; ?>');" title="Clique para solicitar altera&ccedil;&atilde;o do item" class="linksModReadequacao"><?php echo $planilha['Item']; ?></a></td>
                                                                            <td><?php echo $planilha['Unidade']; ?></td>
                                                                            <td><?php echo $planilha['qtItem']; ?></td>
                                                                            <td><?php echo $planilha['nrOcorrencia']; ?></td>
                                                                            <td><?php echo $this->formatarReal($planilha['vlUnitario']); ?></td>
                                                                            <td><?php echo $this->formatarReal($planilha['vlTotal']); ?></td>
                                                                            <td><?php echo $planilha['qtDias']; ?></td>
                                                                            <td><?php echo $planilha['dsJustificativa']; ?></td>
                                                                    </tr>
                                                            <?php
                                                                            $item++;
                                                                    endforeach; //fechaForeachplanilha
                                                            $nrCidade++;
                                                            $totalEtapa   += $totalUF;
                                                            $totalProduto += $totalUF;
                                                            ?>
                                                            <tr>
                                                                <td colspan="5" class="black" style="font-size: 14pt;">Total de UF</td>
                                                                <td class="black" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalUF); ?></td>
                                                                <td colspan="2">&nbsp;</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="orange" style="font-size: 14pt;">Total da Etapa</td>
                                                                <td class="orange" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalEtapa); ?></td>
                                                                <td colspan="2">&nbsp;</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="green" style="font-size: 14pt;">Valor para <?php echo $produto; ?></td>
                                                                <td class="green" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalProduto); ?></td>
                                                                <td colspan="2">&nbsp;</td>
                                                            </tr>
                                                        </table>
                                                    </td>
						</tr>
		<?php
					endforeach; //fechaForeachcidade
					$nrEtapa++;
				endforeach; //fechaForeachetapa
				$totalProduto = 0;
				$nrProduto++;
			endforeach; //fechaForeachproduto
			$nrFonte++;
		endforeach; //fechaForeachFonteIncentivo
		?>
    </table>
	<!-- ========== FIM PLANILHA APROVADA ========== -->



	<!-- ========== INÍCIO FORMULÁRIO ========== -->
	<a name="ancora" id="ancora"></a>
	<form name="formReadequacao" id="formReadequacao" action="<?php echo $this->url(array('controller' => 'readequacao', 'action' => 'custo', 'idproduto' => $this->idProduto)); ?>" method="post" enctype="multipart/form-data">
		<input type="hidden" name="stPedidoAlteracao" id="stPedidoAlteracao" value="T" />
		<input type="hidden" name="siVerificacao" id="siVerificacao" value="0" />
		<input type="hidden" name="tpAlteracaoProjeto" id="tpAlteracaoProjeto" value="10" />
		<input type="hidden" name="tpAcao" id="tpAcao" value="I" />
		<input type="hidden" name="idPlanilhaAprovacao" id="idPlanilhaAprovacao" value="" />
		<input type="hidden" name="tpPlanilhaEnviada" id="tpPlanilhaEnviada" value="" />
		<table class="tabela btnsModReadequacao">
                    <tr>
                        <th colspan="2"><?php echo $dsCusto; ?></th>
                    </tr>
                    <tr class="destacar bold">
                        <td align="center"><label for="etapa">ETAPA / META</label></td>
                        <td align="center"><label for="item">ITEM</label></td>
                    </tr>
                    <tr class="linha">
                        <td align="center" class="w30p">
                            <select name="etapa" id="etapa" class="select_simples preenchimentoObg">
                                <option value=""> - Selecione - </option>
                                <?php foreach ($this->etapas as $e) : ?>
                                <?php if (!empty($this->idProduto) && $e->tpCusto == 'P') : ?>
                                <option value="<?php echo $e->idPlanilhaEtapa.':'.$this->idProduto; ?>"><?php echo $e->Descricao; ?></option>
                                <?php elseif (empty($this->idProduto) && $e->tpCusto == 'A' && $e->idPlanilhaEtapa != 6) : ?>
                                <option value="<?php echo $e->idPlanilhaEtapa.':0'; ?>"><?php echo $e->Descricao; ?></option>
                                <?php endif; ?>
                                <?php endforeach; ?>
                            </select>
                        </td>
                        <td>
                            <select name="item" id="item" class="select_simples w100p preenchimentoObg">
                                <option value=""> - Selecione - </option>
                            </select>
                        </td>
                    </tr>
		</table>

		<table class="tabela btnsModReadequacao">
                    <tr>
                        <th colspan="6">Identificadores</th>
                    </tr>
                    <tr class="destacar bold">
                        <td align="center" colspan="3">F&Iacute;SICOS</td>
                        <td align="center" colspan="2">FINANCEIROS</td>
                        <td align="center">TEMPO DE DURA&Ccedil;&Atilde;O</td>
                    </tr>
                    <tr>
                        <td align="left">
                            <label for="unidade">Unidade <span class="red">*</span></label><br />
                            <select name="unidade" id="unidade" class="select_simples preenchimentoObg">
                                <option value=""> - Selecione - </option>
                                <?php foreach ($this->unidades as $u) : ?>
                                <option value="<?php echo $u->idUnidade; ?>"><?php echo $u->Descricao; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                        <td align="left">
                            <label for="qtd">Quantidade <span class="red">*</span></label><br />
                            <input type="text" name="qtd" id="qtd" class="input_simples preenchimentoObg" maxlength="7" style="width: 8em;" />
                        </td>
                        <td align="left">
                            <label for="ocorrencia">Ocorr&ecirc;ncia <span class="red">*</span></label><br />
                            <input type="text" name="ocorrencia" id="ocorrencia" class="input_simples preenchimentoObg" maxlength="4" style="width: 8em;" />
                        </td>
                        <td align="left">
                            <label for="vlUnitario">Valor Unit&aacute;rio <span class="red">*</span></label><br />
                            <input type="text" name="vlUnitario" id="vlUnitario" class="input_simples preenchimentoObg" maxlength="13" style="width: 8em;" />
                        </td>
                        <td align="right">
                            <label for="total">Total</label><br />
                            <input type="text" name="total" id="total" class="checkradio direita" style="width: 8em;" title="Total = Quantidade X Ocorr&ecirc;ncia X Valor Unit&aacute;rio" />
                        </td>
                        <td align="left">
                            <label for="dias">Qtd. de Dias <span class="red">*</span></label><br />
                            <input type="text" name="dias" id="dias" class="input_simples preenchimentoObg" maxlength="6" style="width: 8em;" />
                        </td>
                    </tr>
		</table>

		<table class="tabela btnsModReadequacao">
                    <tr>
                        <th colspan="3">Despesas</th>
                    </tr>
                    <tr class="destacar bold">
                        <td align="center">DESPESAS</td>
                        <td align="center" colspan="2">LOCALIZA&Ccedil;&Atilde;O DE DESPESAS</td>
                    </tr>
                    <tr class="linha">
                        <td align="left">
                            <label for="fonte">Fonte de Recurso</label><br />
                            <select class="select_simples preenchimentoObg" name="fonte" id="fonte">
                                <option value=""> - Selecione - </option>
                                <?php foreach ($this->fontes as $f) : ?>
                                <option value="<?php echo $f->idVerificacao; ?>"><?php echo $f->dsVerificacao; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                        <td align="left">
                            <label for="uf">UF <span class="red">*</span></label>
                            <select class="select_simples preenchimentoObg" name="uf" id="uf">
                                <option value=""> - Selecione - </option>
                                <?php foreach ($this->uf as $u) : ?>
                                <option value="<?php echo $u->idUF; ?>"><?php echo $u->Sigla; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                        <td align="left">
                            <label for="cidade">Munic&iacute;pio <span class="red">*</span></label>
                            <select class="select_simples preenchimentoObg" name="cidade" id="cidade">
                                <option value=""> - Selecione - </option>
                            </select>
                        </td>
                    </tr>
		</table>

		<table class="tabela btnsModReadequacao">
                    <tr>
                        <th>Justificativa <span class="red">*</span></th>
                    </tr>
                    <tr>
                        <td>
                            <textarea class="input_simples w99p preenchimentoObg" cols="" rows="7" id="justificativa" name="justificativa"></textarea>
                            <span style="float: left; color: red;">Limite máximo de 600 caracteres</span>
                        </td>
                    </tr>
		</table>

		<table class="tabela btnsModReadequacao">
                    <tr>
                        <td align="center">
                            <input type="button" name="btn_salvar" id="btn_salvar" class="btn_salvar" value=" " title="Salvar" />
                            <input type="button" name="btn_exclusao" id="btn_exclusao" class="btn_exclusao sumir" value=" " title="Excluir" />
                            <input type="reset" name="btn_cancelar" id="btn_cancelar" class="btn_cancelar" value=" " title="Cancelar" />
                        </td>
                    </tr>
		</table>
	</form>
	<!-- ========== FIM FORMULÁRIO ========== -->


	<!-- ========== INÍCIO PLANILHA SOLICITADA ========== -->
	<table class="tabela">
            <tr>
                <th>Planilha Solicitada</th>
            </tr>

            <?php if (count($this->planSR) <= 0) : ?>
            <tr>
                <td align="center">N&atilde;o existe(m) item(ns) solicitado(s) para esse produto.</td>
            </tr>
            <?php endif; ?>

		<?php
		$nrFonte = 0;
		$item    = 1;
		foreach ($this->planSR as $fonte => $planilha) : //ForeachFonteIncentivo
                ?>
                    <tr>
                        <td>
                            <div tipoSR="fonteSR" fonteSR="<?php echo $nrFonte; ?>SR" abertoSR="true" class="icn_menos icn_menos_SR" style="width:90%"><span class="red" style="font-size: 20pt; font-weight: 800;"><?php echo $fonte; ?></span></div>
                        </td>
                    </tr>
			<?php
			$nrProduto    = 0;
			$totalProduto = 0;
			if (is_array($this->planSR[$fonte]))
				foreach ($this->planSR[$fonte] as $produto => $planilha) : //ForeachProduto
			?>
				<tr class="masterSR" fonteSR="<?php echo $nrFonte; ?>SR">
                                    <td class="masterSR">
                                        <div tipoSR="produtoSR" abertoSR="true" fonteSR="<?php echo $nrFonte; ?>SR" produtoSR="<?php echo $nrProduto; ?>SR" class="icn_menos icn_menos_SR clickprodutoSR" style="width:98%; margin-left:2%;"><span class="green" style="font-size: 16pt; font-weight: 800;"><?php echo $produto; ?></span></div>
                                    </td>
				</tr>
				<?php
				$nrEtapa = 0;
				if (is_array($this->planSR[$fonte][$produto]))
					foreach ($this->planSR[$fonte][$produto] as $etapa => $planilha) : //ForeachEtapa
						$totalEtapa = 0;
				?>
					<tr class="masterSR produtoSR" produtoSR="<?php echo $nrProduto; ?>SR" fonteSR="<?php echo $nrFonte;?>SR">
                                            <td>
                                                <div>
                                                    <div tipoSR="etapaSR" fonteSR="<?php echo $nrFonte; ?>SR" produtoSR="<?php echo $nrProduto; ?>SR" etapaSR="<?php echo $nrEtapa; ?>SR" abertoSR="true" class="icn_menos icn_menos_SR clicketapaSR" style="width:80%; margin-left:4%; "><span class="orange" style="font-size: 14pt; font-weight: 800;"><?php echo $etapa; ?></span></div>
                                                </div>
                                            </td>
					</tr>
					<?php
					$nrCidade = 0;
						if (is_array($this->planSR[$fonte][$produto][$etapa]))
							foreach ($this->planSR[$fonte][$produto][$etapa] as $cidade => $planilha) : //ForeachCidade
                                                ?>
						<tr class="masterSR produtoSR etapaSR" produtoSR="<?php echo $nrProduto; ?>SR" etapaSR="<?php echo $nrEtapa; ?>SR" fonteSR="<?php echo $nrFonte; ?>SR">
                                                    <td>
                                                        <div tipoSR="cidadeSR" fonteSR="<?php echo $nrFonte; ?>SR" produtoSR="<?php echo $nrProduto; ?>SR" etapaSR="<?php echo $nrEtapa; ?>SR" cidadeSR="<?php echo $nrCidade; ?>SR" abertoSR="true" class="icn_menos icn_menos_SR clickcidadeSR" style="width:94%; margin-left:6%;"><span class="black" style="font-size: 12pt; font-weight: 800;"><?php echo $cidade; ?></span></div>
                                                    </td>
						</tr>
						<tr class="masterSR produtoSR etapaSR cidadeSR" produtoSR="<?php echo $nrProduto; ?>SR" etapaSR="<?php echo $nrEtapa; ?>SR" cidadeSR="<?php echo $nrCidade; ?>SR" fonteSR="<?php echo $nrFonte; ?>SR">
                                                    <td>
                                                        <table class="tabela">
                                                            <tr class="masterSR produtoSR etapaSR cidadeSR" produtoSR="<?php echo $nrProduto; ?>SR" etapaSR="<?php echo $nrEtapa; ?>SR" cidadeSR="<?php echo $nrCidade; ?>SR" fonteSR="<?php echo $nrFonte;?>SR">
                                                                <th>Item</th>
                                                                <th>Unidade</th>
                                                                <th>Quant.</th>
                                                                <th>Ocorr.</th>
                                                                <th>Vl. Unit&aacute;rio</th>
                                                                <th>Total</th>
                                                                <th>Qtd. Dias</th>
                                                                <th>Justificativa Proponente</th>
                                                                <th>A&ccedil;&atilde;o</th>
                                                                <!--<th>Avalia&ccedil;&atilde;o MinC</th>
                                                                <th>Justificativa MinC</th>-->
                                                            </tr>
                                                            <?php $totalUF=0; foreach ($planilha as $planilha) { $totalUF += $planilha['vlTotal']; ?>
                                                            <?php
                                                                switch ($planilha['tpAcao']) {
                                                                    case 'I':
                                                                        $corLinha = 'style="color: blue; font-weight: bold;"';
                                                                        break;
                                                                    case 'E':
                                                                        $corLinha =  'style="color: red; font-weight: bold;"';
                                                                        break;
                                                                    case 'A':
                                                                        $corLinha =  'style="color: green; font-weight: bold;"';
                                                                        break;
                                                                    default:
                                                                        $corLinha =  '';
                                                                        break;
                                                                }; ?>
                                                            <tr class="item" <?php echo $corLinha; ?>>
                                                                <td><a href="javascript:alterar_item('<?php echo $planilha['idPlanilhaAprovacao']; ?>');" title="Clique para solicitar altera&ccedil;&atilde;o do item" class="linksModReadequacao"><?php echo $planilha['Item']; ?></a></td>
                                                                <td><?php echo $planilha['Unidade']; ?></td>
                                                                <td><?php echo $planilha['qtItem']; ?></td>
                                                                <td><?php echo $planilha['nrOcorrencia']; ?></td>
                                                                <td><?php echo $this->formatarReal($planilha['vlUnitario']); ?></td>
                                                                <td><?php echo $this->formatarReal($planilha['vlTotal']); ?></td>
                                                                <td><?php echo $planilha['qtDias']; ?></td>
                                                                <td><?php echo $planilha['dsJustificativa']; ?></td>
                                                                <td><?php
                                                                    switch ($planilha['tpAcao']) {
                                                                        case 'I':
                                                                            echo 'INCLUIR';
                                                                            break;
                                                                        case 'E':
                                                                            echo 'EXCLUIR';
                                                                            break;
                                                                        case 'A':
                                                                            echo 'ALTERAR';
                                                                            break;
                                                                        default:
                                                                            echo '';
                                                                            break;
                                                                    }; ?>
                                                                </td>
                                                                <!--<td><?php echo $planilha['stAvaliacaoItem']; ?></td>
                                                                <td><?php echo $planilha['dsAvaliacaoItem']; ?></td>-->
                                                            </tr>
                                                            <?php } ?>
                                                            <tr>
                                                                <td colspan="5" class="black" style="font-size: 14pt;">Total de UF</td>
                                                                <td class="black" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalUF); ?></td>
                                                                <td colspan="3">&nbsp;</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="orange" style="font-size: 14pt;">Total da Etapa</td>
                                                                <td class="orange" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalEtapa); ?></td>
                                                                <td colspan="3">&nbsp;</td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="green" style="font-size: 14pt;">Valor para <?php echo $produto; ?></td>
                                                                <td class="green" style="font-size: 12pt; font-weight: 600;"><?php echo $this->formatarReal($totalProduto); ?></td>
                                                                <td colspan="3">&nbsp;</td>
                                                            </tr>
                                                        </table>
                                                    </td>
						</tr>
		<?php
					endforeach; //fechaForeachcidade
					$nrEtapa++;
				endforeach; //fechaForeachetapa
				$totalProduto = 0;
				$nrProduto++;
			endforeach; //fechaForeachproduto
			$nrFonte++;
		endforeach; //fechaForeachFonteIncentivo
		?>
        </table>
	<!-- ========== FIM PLANILHA SOLICITADA ========== -->

	<!-- ========== INÍCIO HISTÓRICO ========== -->
	<div id="historico"></div>
	<script type="text/javascript">
	<?php if (empty($this->idProduto)) : ?>
	carregaDados('<?php echo $this->url(array('controller' => 'readequacao', 'action' => 'historico-custo-administrativo')); ?>', 'historico');
	<?php else : ?>
	carregaDados('<?php echo $this->url(array('controller' => 'readequacao', 'action' => 'historico-custo-produtos')); ?>', 'historico');
	<?php endif; ?>
	</script>
	<!-- ========== FIM HISTÓRICO ========== -->

</div>
<!-- ========== FIM CONTEÚDO ========== -->

<!-- ========== INÍCIO RODAPÉ DO CONTEÚDO ========== -->
<div id="rodapeConteudo"><span></span></div>
<!-- ========== FIM RODAPÉ DO CONTEÚDO ========== -->
<br clear="all" />