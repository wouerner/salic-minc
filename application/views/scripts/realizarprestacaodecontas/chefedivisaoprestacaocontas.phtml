<?php
/**
 * Prestação de Contas (UC45) - Coordenador de Prestação de Contas
 * @author Equipe RUP - Politec
 * @since 27/12/2010
 * @version 1.0
 * @subpackage application.view.scripts.chefedivisaoprestacaocontas
 * @copyright © 2010 - Ministério da Cultura - Todos os direitos reservados.
 * @link http://www.cultura.gov.br
 */
?>
<script language="javascript">

    $(document).ready(function() {
        $("#btn_pesquisar").click(function(){
            var pronac = $('#pronacPesquisa').val(),
                filtro = $('#tipoFiltro').val();
            window.location = "<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')); ?>?pag=1&tipoFiltro="+filtro+"&pronac="+pronac;
        });
        
        $('#pronacPesquisa').keydown(function(event){
            if(event.keyCode == 13){
                $("#btn_pesquisar").click();
            }
        });

        $('.btn_imprimir').click(function(){
            $('#addCampoXls').remove();
            $('#formImpressao').submit();
        });
        
        $('.btn_xls').click(function(){
            $('#addCampoXls').remove();
            $('#formImpressao').append('<input id="addCampoXls" type="hidden" name="xls" value="1">');
            $('#formImpressao').submit();
        });
    });

    function JSEncaminharParaConsultoriaDI(idPronac,idOrgaoDestino)
    {
        $('html').css('overflow', 'hidden');
        $("body").append("<div id='divDinamica'></div>");
        $("#divDinamica").html("");
        $('#divDinamica').html("<br><br><center>Carregando dados...</center>");
        $.ajax({
            url : '<?php echo $this->url ( array ('controller' => 'realizarprestacaodecontas', 'action' => 'encaminharprestacaodecontas' ));?>',
            data :
                {
                idPronac : idPronac,
                idOrgaoDestino : idOrgaoDestino,
                idSituacaoPrestContas : 1,
                pag : 1
            },
            success: function(data){
                $('#divDinamica').html(data);
            },
            type : 'post'
        });

        var title = '';
        if(idOrgaoDestino == 177){
            title = 'Consultoria - AECI';
        }else if(idOrgaoDestino == 12){
            title = 'Consultoria - CONJUR';
        }else{
            title = 'Encaminhar Projeto para Análise';
        }
        $("#divDinamica").dialog({
            resizable: true,
            width:750,
            height:550,
            modal: true,
            autoOpen:true,
            draggable:false,
            title: title,
            buttons: {
                'Cancelar': function() {
                    $("#divDinamica").remove();
                    $(this).dialog('close');
                    $('html').css('overflow', 'auto');
                }
            },
            close: function() {
                $("#divDinamica").remove();
                $(this).dialog('close');
                $('html').css('overflow', 'auto');
            }
        });
    }

    function JSEncaminharParaTecnico(idPronac,idOrgaoDestino,tipoFiltro,ocultarJustificativa){               
        $('html').css('overflow', 'hidden');
        $("body").append("<div id='divDinamica'></div>");
        $("#divDinamica").html("");
        $('#divDinamica').html("<br><br><center>Carregando dados...</center>");
        $.ajax({
            url : '<?php echo $this->url ( array ('controller' => 'realizarprestacaodecontas', 'action' => 'encaminharprestacaodecontas' )); ?>',
            data : {
                idPronac : idPronac,
                idOrgaoDestino : idOrgaoDestino,
                idSituacaoPrestContas : 1,
                tipoFiltro : tipoFiltro,
                ocultarJustificativa : true,
                idPerfilDestino: 124
            },
            success: function(data){
                $('#divDinamica').html(data);
            },
            type : 'post'
        });

        var title = 'Encaminhar Projeto para Técnico';
        $("#divDinamica").dialog({
            resizable: true,
            width:750,
            height:550,
            modal: true,
            autoOpen:true,
            draggable:false,
            title: title,
            buttons: {
                'Cancelar': function() {
                    $("#divDinamica").remove();
                    $(this).dialog('close');
                    $('html').css('overflow', 'auto');
                }
            },
            close: function() {
                $("#divDinamica").remove();
                $(this).dialog('close');
                $('html').css('overflow', 'auto');
            }
        });
    }

    function JShistoricoEncaminhamentoDI(idPronac)
    {
        $('html').css('overflow', 'hidden');
        $("body").append("<div id='divDinamicaHistorico'></div>");
        $("#divDinamicaHistorico").html("");
        $('#divDinamicaHistorico').html("<br><br><center>Carregando dados...</center>");
        $.ajax({
            url : '<?php echo $this->url ( array ('controller' => 'realizarprestacaodecontas', 'action' => 'historicoencaminhamento' ));?>?idPronac='+idPronac,
            data : {
                idPronac : idPronac
            },
            success: function(data){
                $('#divDinamicaHistorico').html(data);
            },
            type : 'post'
        });

        $("#divDinamicaHistorico").dialog({
            resizable: true,
            width:750,
            height:550,
            modal: true,
            autoOpen:true,
            draggable:false,
            title: 'Hist&oacute;rico de Encaminhamento do Projeto',
            buttons: {
                'OK': function() {
                    $("#divDinamicaHistorico").remove();
                    $(this).dialog('close');
                    $('html').css('overflow', 'auto');
                }
            },
            close: function() {
                $("#divDinamicaHistorico").remove();
                $(this).dialog('close');
                $('html').css('overflow', 'auto');
            }
        });
    }

</script>
<div id="enviar-confirm" class="sumir" title="Envio de Projeto"><p>Deseja Finalizar o Projeto....?</p></div>

<div id="breadcrumb">
    <ul>
        <li class="first">
            <a href="<?php echo $this->url(array('controller' => 'principal', 'action' => ''), '', true); ?>" title="Ir para p&aacute;gina inicial">Início</a>
        </li>
        <li>Presta&ccedil;&atilde;o de contas</li>
        <li class="last">Analisar presta&ccedil;&atilde;o de contas</li>
    </ul>
</div>


<!-- ========== INÍCIO TÍTULO ========== -->
<div id="titulo">
    <div>Analisar presta&ccedil;&atilde;o de contas - <?php echo ($this->filtro == 'diligenciados') ? 'Projetos Diligenciados' : 'Aguardando Análise'; ?>
        <span class="voltar" style="float: right;">
            <a href="javascript:voltar();" title="Ir para p&aacute;gina anterior">Voltar</a>
        </span>
    </div>
    <span class="sembarra"></span>
</div>
<!-- ========== FIM TÍTULO ========== -->


<!-- ========== INÍCIO CONTEÚDO ========== -->
<div id="conteudo">
    <table class="tabela">
	<tr>
            <td class="destacar bold" width="1" align="center">Pronac</td>
            <td width="100">
                <input type="text" class="input_simples" name="pronacPesquisa" id="pronacPesquisa" maxlength="7" style="width: 90px;" value="<?php echo $this->pronacProjeto;?>">
            </td>
            <td width="150">
                <select name="tipoFiltro" id="tipoFiltro" class="input_simples">
                    <option value="">Aguardando análise</option>
                    <option value="diligenciados" <?php echo (isset($_GET['tipoFiltro']) && $_GET['tipoFiltro']=='diligenciados')?'selected="selected"':''; ?>>Projetos diligenciados</option>
                </select>
            </td>
            <td>
                <input type="button" name="btn_pesquisar" id="btn_pesquisar" class="btn_pesquisar" value="">
            </td>
        </tr>
    </table>

    <?php if(count($this->dados)>0){ ?>
    <!-- ============ PAGINAÇÃO ============ -->
    <table class="tabela" style="width: 97%;" border="0" cellpadding="0" cellspacing="0">
        <tbody>
            <tr>
                <td align="center">
                <form name="form1" id="form1" action="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas'));?>" method="get">
                    <?php if($this->paginacao['pag']>1) { ?>
                    <input class="btn_inicio" id="btn_inicio" type="button" class="btn_inicio"
                           onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1'."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'">
                    <?php } ?>
                    <input id="btn_p_anterior" type="button"
                    <?php if($this->paginacao['pag']<=1) { ?> class="btn_p_anterior-off"
                    <?php }else { ?>
                           class="btn_p_anterior" onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['pag'] - 1)."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'"
                    <?php } ?>>
                    <input id="btn_p_proximo" type="button"
                           <?php if($this->paginacao['pag']+1 > $this->paginacao['totalPag']) { ?>
                           class="btn_p_proximo-off"
                    <?php }else { ?>
                           class="btn_p_proximo" onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['pag'] + 1)."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'"
                    <?php } ?>>
                    <?php if($this->paginacao['pag'] < $this->paginacao['totalPag']) { ?>
                    <input class="btn_ultimo" id="btn_ultimo" type="button"
                           onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['totalPag'])."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'">
                    <?php } ?>
                    Pág.:<select name="pag" id="pag" onchange="$('#form1').submit()" class="input_simples">
                        <?php for($i=1; $i<=$this->paginacao['totalPag']; $i++):?>
                        <option value="<?php echo $i;?>" <?php if($this->paginacao['pag'] == $i) echo "selected";?>><?php echo $i;?>&nbsp;</option>
                        <?php endfor; ?>
                    </select>
                    &nbsp;Registros por página:<input type="text" size="1" name="qtde" id="qtde" class="input_simples" value="<?php echo $this->intTamPag;?>">
                    <input type="submit" class="btn_recarregar" value="">
                    <input type="hidden" name="campo" value="<?php echo $this->paginacao['campo'];?>">
                    <input type="hidden" name="ordem" value="<?php echo $this->paginacao['ordem'];?>">
                    <input type="hidden" name="tipoFiltro" value="<?php echo $this->filtro;?>">
                    <input type="hidden" name="pronac" value="<?php echo $this->pronacProjeto;?>">
                    <input type="button" class="btn_imprimir" title="Imprimir" />
                    <input type="button" class="btn_xls" title="Gerar Excel" />
                 </form>
                </td>
            </tr>
        </tbody>
    </table>
    <center>
        <?php
            echo $this->paginacao['inicio']." a ";
            echo ($this->paginacao['pag']-1)*$this->paginacao['Itenspag'] + $this->paginacao['tamanho'];
            echo " de ". $this->paginacao['total']. " Projetos listados";
        ?>
    </center>
    <!-- ========== FIM PAGINAÇÃO ========== -->
    <?php } ?>

    <?php if($this->qtdRegistros > 0){ ?>
    <table class="tabela tablesorter">
        <thead>
            <tr class="titulo_tabela">
                <th width="1px">#</th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=2&ordem='.$this->paginacao['novaOrdem'];?>">PRONAC</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=3&ordem='.$this->paginacao['novaOrdem'];?>">Nome do Projeto</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=6&ordem='.$this->paginacao['novaOrdem'];?>">Situação</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=7&ordem='.$this->paginacao['novaOrdem'];?>">Área / Segmento</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=4&ordem='.$this->paginacao['novaOrdem'];?>">Estado</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=9&ordem='.$this->paginacao['novaOrdem'];?>">Mecanismo</a></th>
                <th><a href="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1&qtde='.$this->paginacao['qtde'].'&tipoFiltro='.$this->filtro.'&campo=5&ordem='.$this->paginacao['novaOrdem'];?>">Dt. Recebimento</a></th>
                <th>Analisar Prestação de Contas</th>
                <?php if($this->filtro == 'diligenciados'){ ?>
                    <th>Consultoria AECI</th>
                    <th>Consultoria CONJUR</th>
                    <th>Visualizar Histórico</th>
                <?php } ?>
                <th>Encaminhar para T&eacute;cnico</th>
                <th>Diligência</th>
            </tr>
        </thead>
        <tbody>
            <?php $x=1; foreach($this->dados as $projeto){ ?>
            <tr>
                <td align="center"><?php echo $x; ?></td>
                <td align="center">
                    <a href="<?php echo $this->url(array('controller' => 'consultardadosprojeto', 'action' => 'index'));?>?idPronac=<?php echo ($projeto->idPronac); ?>" target="_blank">
                        <?php echo $projeto->Pronac; ?>
                    </a>
                </td>
                <td><?php echo $projeto->NomeProjeto; ?></td>
                <td align="center"><?php echo $projeto->Situacao; ?></td>
                <td><?php echo $projeto->Area.' / '.$projeto->Segmento; ?></td>
                <td align="center"><?php echo $projeto->UfProjeto; ?></td>
                <td align="center"><?php $mecanismo = $projeto->Mecanismo; if ($mecanismo == 'Mecenato'){ echo "Incentivo Fiscal"; }else{ echo $projeto->Mecanismo;}?></td>
                <td align="center"><?php echo Data::tratarDataZend($projeto->DtSituacao, 'brasileira');?></td>
                <td align="center"><img style="cursor: pointer;" src="<?php echo $this->baseUrl(); ?>/public/img/table_multiple.png" onclick="window.location='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'planilhaorcamentaria', 'idPronac' => $projeto->idPronac)); ?>'" alt="Analisar"></td>
                <td align="center">
                    <img style="cursor: pointer;" src="<?php echo $this->baseUrl(); ?>/public/img/user_gray.png" onclick="return JSEncaminharParaTecnico('<?php echo $projeto->idPronac; ?>','<?php echo $this->codOrgao; ?>','<?php echo (isset($_GET['tipoFiltro']) && !empty($_GET['tipoFiltro'])) ? $_GET['tipoFiltro'] : 0; ?>',true)" alt="Encaminhar para técnico" />
                </td>                        
                <?php if($this->filtro == 'diligenciados'){ ?>
                    <td align="center"><img style="cursor: pointer;" src="<?php echo $this->baseUrl(); ?>/public/img/user_gray.png" onclick="return JSEncaminharParaConsultoriaDI('<?php echo $projeto->idPronac;?>','177')" alt="Encaminhar" /></td>
                    <td align="center"><img style="cursor: pointer;" src="<?php echo $this->baseUrl(); ?>/public/img/user_gray.png" onclick="return JSEncaminharParaConsultoriaDI('<?php echo $projeto->idPronac;?>','12')" alt="Encaminhar" /></td>
                    <td align="center"><img style="cursor: pointer;" src="<?php echo $this->baseUrl(); ?>"/public/img/btn_busca.jpg" onclick="return JShistoricoEncaminhamentoDI('<?php echo $projeto->idPronac; ?>')" alt="Visualizar Histórico" />
                <?php } ?>
                <td background="" align="center">
                    <?php
                        $arrPrazo = $this->prazoRespostaDiligencia($projeto->idPronac, 174);
                        $icone = $arrPrazo['iconeDiligencia']['icone'];
                        $title = $arrPrazo['iconeDiligencia']['title'];
                    ?>
                    <?php if($this->filtro == 'diligenciados'){ ?>
                    <a target="_blank" href="<?php echo $this->url(array('controller' => 'diligenciar', 'action' =>'listardiligenciaanalista')).'?idPronac=' . $projeto->idPronac . '&situacao=E17&tpDiligencia=174';?>" ><img src="<?php echo $this->baseUrl(); ?>/public/img/<?php echo $icone; ?>" title="<?php echo $title; ?>" width="30px"/></a><br>
                    <?php } else { ?>
                    <a target="_blank" href="<?php echo $this->url(array('controller' => 'diligenciar', 'action' =>'listardiligenciaanalista')).'?idPronac=' . $projeto->idPronac . '&situacao=E27&tpDiligencia=174';?>" ><img src="<?php echo $this->baseUrl(); ?>/public/img/<?php echo $icone; ?>" title="<?php echo $title; ?>" width="30px"/></a><br>
                    <?php } ?>
                </td>
            </tr>
            <?php $x++; } ?>

        </tbody>
    </table>

    <?php if(count($this->dados)>0){ ?>

        <!-- ============ PAGINAÇÃO ============ -->
        <?php if($this->qtdRegistros > 10) { //echo $this->dados; ?>
        <center>
            <?php
                echo $this->paginacao['inicio']." a ";
                echo ($this->paginacao['pag']-1)*$this->paginacao['Itenspag'] + $this->paginacao['tamanho'];
                echo " de ". $this->paginacao['total'];
            ?>
        </center>
        <table class="tabela" style="width: 97%;" border="0" cellpadding="0" cellspacing="0">
            <tbody>
                <tr>
                    <td align="center">
                    <form name="form2" id="form2" action="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas'));?>" method="get">
                        <?php if($this->paginacao['pag']>1) { ?>
                        <input class="btn_inicio" id="btn_inicio" type="button" class="btn_inicio"
                               onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag=1'."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'">
                        <?php } ?>
                        <input id="btn_p_anterior" type="button"
                        <?php if($this->paginacao['pag']<=1) { ?> class="btn_p_anterior-off"
                        <?php }else { ?>
                               class="btn_p_anterior" onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['pag'] - 1)."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'"
                        <?php } ?>>
                        <input id="btn_p_proximo" type="button"
                               <?php if($this->paginacao['pag']+1 > $this->paginacao['totalPag']) { ?>
                               class="btn_p_proximo-off"
                        <?php }else { ?>
                               class="btn_p_proximo" onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['pag'] + 1)."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'"
                        <?php } ?>>
                        <?php if($this->paginacao['pag'] < $this->paginacao['totalPag']) { ?>
                        <input class="btn_ultimo" id="btn_ultimo" type="button"
                               onclick="location.href='<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'chefedivisaoprestacaocontas')).'?pag='.($this->paginacao['totalPag'])."&qtde=".$this->paginacao['qtde'].$this->paginacao['ordenacao'].'&tipoFiltro='.$this->filtro.'&pronac='.$this->pronacProjeto; ?>'">
                        <?php } ?>
                        Pág.:<select name="pag" id="pag" onchange="$('#form2').submit()" class="input_simples">
                            <?php for($i=1; $i<=$this->paginacao['totalPag']; $i++):?>
                            <option value="<?php echo $i;?>" <?php if($this->paginacao['pag'] == $i) echo "selected";?>><?php echo $i;?>&nbsp;</option>
                            <?php endfor; ?>
                        </select>
                        &nbsp;Registros por página:<input type="text" size="1" name="qtde" id="qtde" class="input_simples" value="<?php echo $this->intTamPag;?>">
                        <input type="submit" class="btn_recarregar" value="">
                        <input type="hidden" name="campo" value="<?php echo $this->paginacao['campo'];?>">
                        <input type="hidden" name="ordem" value="<?php echo $this->paginacao['ordem'];?>">
                        <input type="hidden" name="tipoFiltro" value="<?php echo $this->filtro;?>">
                        <input type="hidden" name="pronac" value="<?php echo $this->pronacProjeto;?>">
                        <input type="button" class="btn_imprimir" title="Imprimir" />
                        <input type="button" class="btn_xls" title="Gerar Excel" />
                     </form>
                    </td>
                </tr>
            </tbody>
        </table>
        <!-- ========== FIM PAGINAÇÃO ========== -->
    <?php } } ?>

    <?php } else { ?>
    <table class="tabela">
        <tr>
            <td align="center">Nenhum registro encontrado.</td>
        </tr>
    </table>
    <?php } ?>
    <br clear="all" />

    <form name="formImpressao" id="formImpressao" action="<?php echo $this->url(array('controller' => 'realizarprestacaodecontas', 'action' => 'imprimir-chefe-divisao-prestacao-de-contas'));?>" method="post" target="_blank">
        <input type="hidden" name="campo" value="<?php echo $this->paginacao['campo'];?>">
        <input type="hidden" name="ordem" value="<?php echo $this->paginacao['ordem'];?>">
        <input type="hidden" name="pag" value="<?php echo $this->paginacao['pag'];?>">
        <input type="hidden" name="qtde" value="<?php echo $this->intTamPag;?>">
        <input type="hidden" name="tipoFiltro" value="<?php echo $this->filtro;?>">
        <input type="hidden" name="pronac" value="<?php echo $this->pronacProjeto;?>">
    </form>
    
</div>
<!-- ========== FIM CONTEÚDO ========== -->

<!-- ========== INÍCIO RODAPÉ DO CONTEÚDO ========== -->
<div id="rodapeConteudo"><span></span></div>
<!-- ========== FIM RODAPÉ DO CONTEÚDO ========== -->

<br clear="all" />
